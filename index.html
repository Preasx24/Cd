<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AdRevenuePro - Secure Login</title>
<style>
/* Full UI styling */
*{box-sizing:border-box;margin:0;padding:0;font-family:Segoe UI, Tahoma, Arial, sans-serif}
body{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364)}
.container{width:100%;max-width:560px;background:rgba(255,255,255,0.05);backdrop-filter:blur(10px);border-radius:14px;padding:34px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 15px 35px rgba(0,0,0,0.45);position:relative;overflow:hidden}
.header{text-align:center;margin-bottom:22px}
.logo{font-size:36px;color:#4facfe}
.title{font-size:26px;color:#fff;margin-top:6px;font-weight:700}
.subtitle{color:rgba(255,255,255,0.75);margin-top:6px}
.tabs{display:flex;margin:18px 0;border-bottom:1px solid rgba(255,255,255,0.06)}
.tab{padding:10px 18px;color:rgba(255,255,255,0.75);cursor:pointer;border-bottom:3px solid transparent;transition:all .18s}
.tab.active{color:#4facfe;border-bottom:3px solid #4facfe}
.tab-content{display:none;padding-top:16px}
.tab-content.active{display:block}
.form-group{margin-bottom:14px}
.form-label{color:rgba(255,255,255,0.9);font-size:13px;margin-bottom:6px;display:block}
.form-input{width:100%;padding:12px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:#fff}
.form-input:focus{outline:none;box-shadow:0 0 0 3px rgba(79,172,254,0.08);border-color:#4facfe}
.btn{width:100%;padding:12px 14px;border-radius:10px;border:none;background:linear-gradient(45deg,#4facfe,#00f2fe);color:#fff;font-weight:700;cursor:pointer;margin-top:8px}
.pulse{animation:pulse 2s infinite}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
.password-display{margin-top:12px;padding:14px;border-radius:8px;border:1px dashed rgba(79,172,254,0.25);background:rgba(0,0,0,0.18);color:#4facfe;font-family:monospace;text-align:center;min-height:54px;display:flex;align-items:center;justify-content:center}
.action-row{display:flex;gap:10px;margin-top:12px}
.action-btn{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff;cursor:pointer}
.message{margin-top:12px;padding:10px;border-radius:8px;display:none}
.message.success{background:rgba(79,172,254,0.08);color:#aee6ff}
.message.error{background:rgba(255,107,107,0.08);color:#ffd7d7}
.small{font-size:13px;color:rgba(255,255,255,0.75);margin-top:8px;text-align:center}
</style>
</head>
<body>
  <div class="container" id="app">
    <div class="header">
      <div class="logo">ðŸ’°</div>
      <div class="title">AdRevenuePro</div>
      <div class="subtitle">Create account, get an access code, and track revenue</div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="register">Create Account</div>
      <div class="tab" data-tab="login">Login</div>
    </div>

    <!-- Register -->
    <div class="tab-content active" id="register">
      <div class="form-group">
        <label class="form-label">Username</label>
        <input id="username" class="form-input" placeholder="e.g. lefa2023" autocomplete="off" />
      </div>

      <div class="form-group">
        <label class="form-label">Campaign Name</label>
        <input id="specificText" class="form-input" placeholder="e.g. SummerPromo" autocomplete="off" />
      </div>

      <div class="form-group">
        <label class="form-label">Master Password</label>
        <input id="masterPassword" type="password" class="form-input" placeholder="Create a strong password" autocomplete="off" />
      </div>

      <button id="generateBtn" class="btn pulse">GENERATE ACCESS CODE</button>

      <div id="passwordDisplay" class="password-display">Your 8-character access code will appear here</div>

      <div class="action-row">
        <button id="copyBtn" class="action-btn">Copy Access Code</button>
        <button id="downloadBtn" class="action-btn">Download Details</button>
      </div>

      <div id="regMsg" class="message success"></div>
      <div id="regErr" class="message error"></div>
      <div class="small">After creation, your account mapping and user gist will be created/updated automatically.</div>
    </div>

    <!-- Login -->
    <div class="tab-content" id="login">
      <div class="form-group">
        <label class="form-label">Username</label>
        <input id="loginUsername" class="form-input" placeholder="Your username" autocomplete="off" />
      </div>

      <div class="form-group">
        <label class="form-label">Campaign Name</label>
        <input id="loginSpecificText" class="form-input" placeholder="Campaign name" autocomplete="off" />
      </div>

      <div class="form-group">
        <label class="form-label">Master Password</label>
        <input id="loginMasterPassword" type="password" class="form-input" placeholder="Your master password" autocomplete="off" />
      </div>

      <button id="loginBtn" class="btn">LOGIN TO DASHBOARD</button>

      <div id="loginMsg" class="message success"></div>
      <div id="loginErr" class="message error"></div>
    </div>
  </div>

<script>
/* ----------------------
   Config: your gists
   ---------------------- */
const MAPPING_RAW_URL = "https://gist.githubusercontent.com/Preasx24/4517ac43eff88b7e226fbbdc627a3c08/raw/gistfile1.txt";
const MAPPING_GIST_ID = "4517ac43eff88b7e226fbbdc627a3c08";
const TOKEN_GIST_RAW = "https://gist.githubusercontent.com/Preasx24/c54812fe3d3e5f8d586f1dd010701919/raw/e6ebaaa6f2bb72ad1d2444b10ffb059f9c990fbe/gistfile1.txt";

/* ----------------------
   Utility & UI helpers
   ---------------------- */
function $id(id){ return document.getElementById(id); }
function showMessage(el, text){ el.textContent = text; el.style.display = text ? "block" : "none"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* Tab switching */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=> {
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById(t.dataset.tab).classList.add('active');
  });
});

/* ----------------------
   Deterministic access code generator (LCG-based)
   - same inputs -> same code
   ---------------------- */
function stringSeed(s){
  let seed = 2166136261 >>> 0;
  for(let i=0;i<s.length;i++){
    seed ^= s.charCodeAt(i);
    seed = Math.imul(seed, 16777619) >>> 0;
  }
  return seed >>> 0;
}
function lcgNext(seed){ return (Math.imul(seed,1664525) + 1013904223) >>> 0; }
function generateAccessCode(username, specificText, masterPassword){
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let seed = stringSeed(username + '||' + specificText + '||' + masterPassword);
  let code = '';
  for(let i=0;i<8;i++){
    seed = lcgNext(seed);
    code += chars[seed % chars.length];
  }
  return code;
}

/* ----------------------
   GitHub gist helpers
   (token is read from your token gist)
   ---------------------- */
async function getToken(){
  const r = await fetch(TOKEN_GIST_RAW);
  if(!r.ok) throw new Error("Failed to fetch token gist");
  return (await r.text()).trim();
}

async function fetchMapping(){
  try{
    const r = await fetch(MAPPING_RAW_URL);
    if(!r.ok) { console.warn('mapping fetch not ok', r.status); return []; }
    const txt = await r.text();
    // Try parse; mapping may be [] initially
    try { const parsed = JSON.parse(txt); return Array.isArray(parsed) ? parsed : []; } catch(e) {
      // If file empty or not valid JSON, return empty array
      return [];
    }
  } catch(err){
    console.warn('fetchMapping error', err);
    return [];
  }
}

async function saveMapping(token, mapping){
  const api = `https://api.github.com/gists/${MAPPING_GIST_ID}`;
  const body = { files: { "gistfile1.txt": { content: JSON.stringify(mapping, null, 2) } } };
  const r = await fetch(api, { method: "PATCH", headers: { "Authorization": "token " + token.trim(), "Accept":"application/vnd.github+json", "Content-Type":"application/json" }, body: JSON.stringify(body) });
  if(!r.ok) throw new Error("Failed to save mapping gist: " + r.status);
  return await r.json();
}

async function createUserGistOnGithub(token, username, accessCode){
  const api = "https://api.github.com/gists";
  const initialStats = { clicks:0, revenue:0, daily: {}, activity: [] };
  const body = {
    description: `AdRevenuePro stats for ${username}`,
    public: false,
    files: { "stats.json": { content: JSON.stringify(initialStats, null, 2) } }
  };
  const r = await fetch(api, { method: "POST", headers: { "Authorization":"token "+token.trim(), "Accept":"application/vnd.github+json", "Content-Type":"application/json" }, body: JSON.stringify(body) });
  if(!r.ok){ const txt = await r.text(); throw new Error("Create gist failed: "+r.status+" "+txt); }
  return await r.json(); // contains id and html_url
}

async function deleteGistOnGithub(token, gistId){
  const api = `https://api.github.com/gists/${gistId}`;
  const r = await fetch(api, { method: "DELETE", headers: { "Authorization":"token "+token.trim() } });
  return r.ok;
}

/* ----------------------
   Core flow: Registration
   ---------------------- */
async function registerUser(username, specificText, masterPassword){
  // create deterministic access code
  const accessCode = generateAccessCode(username, specificText, masterPassword);

  // UI feedback
  $id('passwordDisplay').textContent = accessCode;
  showMessage($id('regMsg'), "Generating account... please wait");
  showMessage($id('regErr'), "");

  // Try to fetch existing mapping
  let mapping = await fetchMapping();

  // If mapping already contains this accessCode -> use it
  const existing = mapping.find(e => e.accessCode === accessCode);
  if(existing){
    const userData = { username, specificText, accessCode, gistUrl: existing.gistUrl, gistId: existing.gistId || null };
    localStorage.setItem('adRevenueUser', JSON.stringify(userData));
    showMessage($id('regMsg'), "Account exists â€” mapped to existing gist.");
    // Switch to login tab automatically
    switchToLogin(userData);
    return userData;
  }

  // No mapping -> create new gist and update mapping
  try{
    const token = await getToken();
    // Create the user gist
    const created = await createUserGistOnGithub(token, username, accessCode);
    const gistUrl = created.html_url;
    const gistId = created.id;

    // Re-fetch mapping to protect against race condition
    await sleep(300);
    mapping = await fetchMapping();
    const race = mapping.find(e => e.accessCode === accessCode);
    if(race){
      // someone else created mapping concurrently -> delete our created gist to avoid duplicates
      await deleteGistOnGithub(token, gistId).catch(()=>{/*ignore*/});
      const userData = { username, specificText, accessCode, gistUrl: race.gistUrl, gistId: race.gistId || null };
      localStorage.setItem('adRevenueUser', JSON.stringify(userData));
      showMessage($id('regMsg'), "Another process created this mapping â€” using existing mapping.");
      switchToLogin(userData);
      return userData;
    }

    // safe to add our entry to mapping
    const newEntry = { username, accessCode, gistUrl, gistId };
    mapping.push(newEntry);
    await saveMapping(token, mapping);

    const userData = { username, specificText, accessCode, gistUrl, gistId };
    localStorage.setItem('adRevenueUser', JSON.stringify(userData));
    showMessage($id('regMsg'), "Account created and mapping saved.");
    switchToLogin(userData);
    return userData;

  } catch(err){
    console.error("registerUser error", err);
    showMessage($id('regErr'), "Failed to create account: " + (err.message||err));
    throw err;
  }
}

/* ----------------------
   Helper: switch to login tab and prefill
   ---------------------- */
function switchToLogin(userData){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  const t = document.querySelector('.tab[data-tab="login"]');
  t.classList.add('active');
  document.getElementById('login').classList.add('active');
  $id('loginUsername').value = userData.username || "";
  $id('loginSpecificText').value = userData.specificText || "";
  // clear master password input
  $id('loginMasterPassword').value = "";
}

/* ----------------------
   Login flow
   ---------------------- */
function loginUser(username, specificText, masterPassword){
  showMessage($id('loginMsg'), "");
  showMessage($id('loginErr'), "");
  const saved = JSON.parse(localStorage.getItem('adRevenueUser')||"{}");
  if(!saved || !saved.username){
    showMessage($id('loginErr'), "No saved account on this browser â€” please register first.");
    return false;
  }
  // verify username matches saved username (we only allow login to the saved account)
  if(username !== saved.username || specificText !== saved.specificText){
    showMessage($id('loginErr'), "Username or campaign does not match the saved account.");
    return false;
  }
  const expected = generateAccessCode(username, specificText, masterPassword);
  if(expected === saved.accessCode){
    showMessage($id('loginMsg'), "Login successful â€” redirecting to stats...");
    // ensure saved.accessCode is set (in case)
    saved.accessCode = expected;
    localStorage.setItem('adRevenueUser', JSON.stringify(saved));
    setTimeout(()=>window.location.href = 'stats.html', 900);
    return true;
  } else {
    showMessage($id('loginErr'), "Incorrect master password.");
    return false;
  }
}

/* ----------------------
   UI bindings
   ---------------------- */
$id('generateBtn').addEventListener('click', async () => {
  const username = $id('username').value.trim();
  const specificText = $id('specificText').value.trim();
  const masterPassword = $id('masterPassword').value;
  if(!username || !specificText || !masterPassword){
    showMessage($id('regErr'), "Please fill all fields.");
    return;
  }
  try{
    await registerUser(username, specificText, masterPassword);
  }catch(e){
    // error shown inside registerUser
  }
});

$id('copyBtn').addEventListener('click', ()=>{
  const txt = $id('passwordDisplay').textContent.trim();
  if(!txt || txt.includes("Your 8-character")) return alert("No code to copy");
  navigator.clipboard?.writeText(txt).then(()=>alert('Copied to clipboard')).catch(()=>{ alert('Could not copy'); });
});

$id('downloadBtn').addEventListener('click', ()=>{
  const saved = JSON.parse(localStorage.getItem('adRevenueUser')||"{}");
  if(!saved || !saved.accessCode) return alert("No saved details. Generate first.");
  const content = `AdRevenuePro Account\nUsername: ${saved.username}\nCampaign: ${saved.specificText}\nAccessCode: ${saved.accessCode}\nGistURL: ${saved.gistUrl || ""}\n`;
  const blob = new Blob([content], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `adrevenue-${saved.username}.txt`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});

$id('loginBtn').addEventListener('click', ()=>{
  const username = $id('loginUsername').value.trim();
  const specificText = $id('loginSpecificText').value.trim();
  const masterPassword = $id('loginMasterPassword').value;
  if(!username || !specificText || !masterPassword){
    showMessage($id('loginErr'), "Please fill all fields.");
    return;
  }
  loginUser(username, specificText, masterPassword);
});

/* On load: if we have stored user, switch to login tab and prefill */
(function init(){
  const saved = JSON.parse(localStorage.getItem('adRevenueUser')||"{}");
  if(saved && saved.username){
    // switch to login
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    const t = document.querySelector('.tab[data-tab="login"]');
    t.classList.add('active');
    document.getElementById('login').classList.add('active');
    $id('loginUsername').value = saved.username || "";
    $id('loginSpecificText').value = saved.specificText || "";
    $id('passwordDisplay').textContent = saved.accessCode || "Your 8-character access code will appear here";
  }
})();
</script>
</body>
</html>