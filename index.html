<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AdRevenuePro - Secure Login</title>
<style>
  body { background: linear-gradient(135deg,#0f2027,#203a43,#2c5364); min-height:100vh; display:flex; justify-content:center; align-items:center; font-family:sans-serif; }
  .container{width:100%;max-width:480px;background:rgba(255,255,255,0.05);padding:30px;border-radius:12px;color:#fff;}
  .hidden{display:none;}
  input,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none;}
  input{background:rgba(255,255,255,0.1);color:#fff;}
  button{background:#4facfe;color:#fff;cursor:pointer;font-weight:bold;}
  button:hover{background:#2196f3;}
  .password-display{background:#0003;padding:12px;margin-top:10px;text-align:center;border:1px dashed #4facfe;}
</style>
</head>
<body>
<div class="container" id="registerBox">
  <h2>Create Account</h2>
  <input id="username" placeholder="Username">
  <input id="campaign" placeholder="Campaign">
  <input type="password" id="masterPassword" placeholder="Master Password">
  <button onclick="generateAccess()">Generate Access Code</button>
  <div class="password-display" id="generatedCode">Your code will appear here</div>
</div>

<div class="container hidden" id="loginBox">
  <h2>Login</h2>
  <input id="loginUsername" placeholder="Username">
  <input id="loginCampaign" placeholder="Campaign">
  <input type="password" id="loginMasterPassword" placeholder="Master Password">
  <button onclick="login()">Login</button>
</div>

<script>
const tokenUrl="https://gist.githubusercontent.com/Preasx24/c54812fe3d3e5f8d586f1dd010701919/raw/e6ebaaa6f2bb72ad1d2444b10ffb059f9c990fbe/gistfile1.txt";
const mappingUrl="https://gist.githubusercontent.com/Preasx24/4517ac43eff88b7e226fbbdc627a3c08/raw/gistfile1.txt";

function hashCode(str){let h=0;for(let i=0;i<str.length;i++){h=(h<<5)-h+str.charCodeAt(i);h|=0;}return Math.abs(h);}
function generateAccessCode(u,c,m){const seed=hashCode(u+c+m);const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let code="";for(let i=0;i<8;i++){code+=chars.charAt((Math.sin(seed+i)*10000)%chars.length|0);}return code;}

async function updateMapping(accessCode,username,gistUrl){
  try{
    const token=await fetch(tokenUrl).then(r=>r.text());
    const mapping=await fetch(mappingUrl).then(r=>r.json());
    const exists=mapping.some(e=>e.accessCode===accessCode);
    if(!exists){
      mapping.push({username,accessCode,gistUrl});
      const gistApi="https://api.github.com/gists/4517ac43eff88b7e226fbbdc627a3c08";
      await fetch(gistApi,{
        method:"PATCH",
        headers:{
          "Authorization":"token "+token.trim(),
          "Accept":"application/vnd.github+json"
        },
        body:JSON.stringify({files:{"gistfile1.txt":{content:JSON.stringify(mapping,null,2)}}})
      });
      console.log("Mapping gist updated");
    }
  }catch(e){console.error("Mapping update failed:",e);}
}

async function generateAccess(){
  const u=document.getElementById('username').value.trim();
  const c=document.getElementById('campaign').value.trim();
  const m=document.getElementById('masterPassword').value;
  if(!u||!c||!m){alert("Fill all fields");return;}
  const code=generateAccessCode(u,c,m);
  document.getElementById('generatedCode').textContent=code;

  // Create or get user gist URL
  const gistUrl=`https://gist.github.com/${code}`;
  localStorage.setItem("adRevenueUser",JSON.stringify({username:u,campaign:c,accessCode:code,gistUrl}));

  // Update mapping gist
  await updateMapping(code,u,gistUrl);

  alert("Account created. Use login next time.");
}

// Login
function login(){
  const u=document.getElementById('loginUsername').value.trim();
  const c=document.getElementById('loginCampaign').value.trim();
  const m=document.getElementById('loginMasterPassword').value;
  const stored=JSON.parse(localStorage.getItem("adRevenueUser")||"{}");
  if(!u||!c||!m){alert("Fill all fields");return;}
  const expected=generateAccessCode(u,c,m);
  if(expected===stored.accessCode && u===stored.username && c===stored.campaign){
    alert("Login successful");
    window.location.href="stats.html";
  }else alert("Login failed");
}

// Show login if already registered
const stored=localStorage.getItem("adRevenueUser");
if(stored){
  document.getElementById("registerBox").classList.add("hidden");
  document.getElementById("loginBox").classList.remove("hidden");
  const u=JSON.parse(stored);
  document.getElementById("loginUsername").value=u.username;
  document.getElementById("loginCampaign").value=u.campaign;
}
</script>
</body>
</html>