<!DOCTYPE html>
<html>
<head>
    <script>
        const mappingUrl = "https://gist.githubusercontent.com/Preasx24/4517ac43eff88b7e226fbbdc627a3c08/raw/gistfile1.txt";
        const tokenUrl = "https://gist.githubusercontent.com/Preasx24/c54812fe3d3e5f8d586f1dd010701919/raw/e6ebaaa6f2bb72ad1d2444b10ffb059f9c990fbe/gistfile1.txt";
        const targetUrl = "https://otieu.com/4/9515888";
        const code = location.hash.replace("#","").trim();

        async function trackAndRedirect() {
            if (!code) {
                window.location.replace(targetUrl);
                return;
            }

            try {
                // Get token
                const tokenResponse = await fetch(tokenUrl);
                const token = (await tokenResponse.text()).trim();
                
                if (!token) {
                    window.location.replace(targetUrl);
                    return;
                }

                // Get mapping
                const mappingResponse = await fetch(mappingUrl);
                const mappingText = await mappingResponse.text();
                const map = JSON.parse(mappingText);
                
                const entry = map.find(e => e.accessCode === code);
                if (!entry) {
                    window.location.replace(targetUrl);
                    return;
                }

                // Extract gist ID from URL
                const gistId = entry.gistId || entry.gistUrl.split('/').pop();
                const gistApiUrl = `https://api.github.com/gists/${gistId}`;

                // Get current gist data
                const gistResponse = await fetch(gistApiUrl, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!gistResponse.ok) {
                    throw new Error(`Gist fetch failed: ${gistResponse.status}`);
                }

                const gistData = await gistResponse.json();
                
                // Parse current stats
                let stats = { clicks: 0, revenue: 0, daily: {} };
                if (gistData.files && gistData.files['stats.json']) {
                    try {
                        stats = JSON.parse(gistData.files['stats.json'].content);
                    } catch (e) {
                        console.log('Using default stats due to parse error');
                    }
                }

                // Calculate revenue
                const today = new Date().toISOString().slice(0,10);
                let rev = 0.0001 + (Math.random() * 0.0099); // 0.0001 to 0.01

                // Initialize daily tracking
                if (!stats.daily) stats.daily = {};
                if (!stats.daily[today]) stats.daily[today] = { count: 0 };

                // Special case for revenue domain
                if (location.hostname.includes("revenue.dtech-services.co.za")) {
                    if (stats.daily[today].count < 10) {
                        rev = 0.0001 + (Math.random() * 0.0099);
                        stats.daily[today].count++;
                    } else {
                        rev = 0; // Cap reached
                    }
                }

                // Update stats
                stats.clicks = (stats.clicks || 0) + 1;
                stats.revenue = (stats.revenue || 0) + rev;

                // Update gist
                const updateResponse = await fetch(gistApiUrl, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'stats.json': {
                                content: JSON.stringify(stats, null, 2)
                            }
                        }
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error(`Gist update failed: ${updateResponse.status}`);
                }

                console.log(`âœ… Successfully updated stats for ${entry.username}`);

            } catch (error) {
                console.error('Error in tracking:', error);
            } finally {
                // Always redirect
                window.location.replace(targetUrl);
            }
        }

        // Start tracking immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', trackAndRedirect);
        } else {
            trackAndRedirect();
        }
    </script>
</head>
<body>
</body>
</html>