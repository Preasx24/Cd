<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Persistent Gist Stats Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #121212; color: #eee; padding: 2rem; }
    .card { background: #1e1e1e; padding: 1.5rem; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,.5); max-width: 500px; margin: auto; }
    input, button { width: 100%; margin-top: 1rem; padding: 0.75rem; border-radius: 8px; border: none; }
    input { background: #2a2a2a; color: #fff; }
    button { background: #4cafef; color: #fff; font-weight: bold; cursor: pointer; }
    button:hover { background: #2196f3; }
    .hidden { display: none; }
    pre { background: #000; color: #0f0; padding: 1rem; border-radius: 8px; overflow-x: auto; max-height: 200px; }
  </style>
</head>
<body>
  <div class="card" id="authCard">
    <h2>üîê Login</h2>
    <input id="accessCode" placeholder="Enter Access Code" />
    <button onclick="login()">Login</button>
  </div>

  <div class="card hidden" id="dashboard">
    <h2>üìä Dashboard</h2>
    <p id="welcome"></p>
    <button onclick="updateStats()">Update Stats (Save to Gist)</button>
    <p id="gistUrl"></p>
    <h3>Console Log</h3>
    <pre id="console"></pre>
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    const tokenGistUrl = "https://gist.githubusercontent.com/Preasx24/c54812fe3d3e5f8d586f1dd010701919/raw/e6ebaaa6f2bb72ad1d2444b10ffb059f9c990fbe/gistfile1.txt";
    const mappingGistId = "4517ac43eff88b7e226fbbdc627a3c08"; // universal mapping gist ID

    function log(msg) {
      const consoleBox = document.getElementById('console');
      consoleBox.textContent += msg + "\n";
      consoleBox.scrollTop = consoleBox.scrollHeight;
    }

    async function getGitHubToken() {
      log("Fetching GitHub token from gist...");
      const res = await fetch(tokenGistUrl);
      if (!res.ok) throw new Error("Failed to fetch token gist");
      const token = (await res.text()).trim();
      log("‚úÖ Token fetched");
      return token;
    }

    function login() {
      const code = document.getElementById('accessCode').value.trim();
      if (!code) return alert("Enter a valid access code");
      localStorage.setItem("user", JSON.stringify({ accessCode: code, stats: { logins: 0 } }));
      document.getElementById('authCard').classList.add("hidden");
      document.getElementById('dashboard').classList.remove("hidden");
      document.getElementById('welcome').textContent = `Welcome, ${code}`;
      log("üîë Logged in with access code: " + code);
    }

    async function fetchMapping(token) {
      const res = await fetch(`https://api.github.com/gists/${mappingGistId}`, {
        headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" }
      });
      const data = await res.json();
      const fileContent = data.files["gistfile1.txt"].content;
      return JSON.parse(fileContent || "{}");
    }

    async function saveMapping(token, mapping) {
      await fetch(`https://api.github.com/gists/${mappingGistId}`, {
        method: "PATCH",
        headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" },
        body: JSON.stringify({
          files: {
            "gistfile1.txt": { content: JSON.stringify(mapping, null, 2) }
          }
        })
      });
    }

    async function updateStats() {
      let user = JSON.parse(localStorage.getItem("user"));
      if (!user) return alert("Not logged in");

      user.stats.logins += 1;
      localStorage.setItem("user", JSON.stringify(user));

      try {
        const token = await getGitHubToken();
        log("üì° Fetching mapping gist...");
        let mapping = await fetchMapping(token);

        let gistId = mapping[user.accessCode];
        if (!gistId) {
          log("üÜï Creating new gist for this user...");
          const createRes = await fetch("https://api.github.com/gists", {
            method: "POST",
            headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" },
            body: JSON.stringify({
              description: `Stats for ${user.accessCode}`,
              public: false,
              files: { "stats.json": { content: JSON.stringify(user.stats, null, 2) } }
            })
          });
          const createData = await createRes.json();
          gistId = createData.id;
          mapping[user.accessCode] = gistId;
          await saveMapping(token, mapping);
          log("‚úÖ New gist created and mapping updated: " + createData.html_url);
          document.getElementById('gistUrl').textContent = "Gist: " + createData.html_url;
        } else {
          log("‚úèÔ∏è Updating existing gist: " + gistId);
          const patchRes = await fetch(`https://api.github.com/gists/${gistId}`, {
            method: "PATCH",
            headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" },
            body: JSON.stringify({
              files: { "stats.json": { content: JSON.stringify(user.stats, null, 2) } }
            })
          });
          const patchData = await patchRes.json();
          log("‚úÖ Stats updated: " + patchData.html_url);
          document.getElementById('gistUrl').textContent = "Gist: " + patchData.html_url;
        }
      } catch (e) {
        log("‚ùå Error: " + e.message);
      }
    }

    function logout() {
      localStorage.removeItem("user");
      document.getElementById('dashboard').classList.add("hidden");
      document.getElementById('authCard').classList.remove("hidden");
      log("üëã Logged out");
    }
  </script>
</body>
</html>