<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AdRevenuePro - Stats Dashboard</title>
  <style>
    body { background: #0f2027; color: #fff; font-family: Arial, sans-serif; padding: 2rem; }
    .card { background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; }
    h2 { color: #4facfe; }
    input, button { padding: 0.75rem; border-radius: 6px; border: none; margin-top: 0.5rem; width: 100%; }
    input { background: #1e1e1e; color: #fff; }
    button { background: #4facfe; color: #fff; font-weight: bold; cursor: pointer; }
    button:hover { background: #00f2fe; }
    pre { background: #111; padding: 1rem; border-radius: 6px; color: #0f0; max-height: 150px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="card" id="authCard">
    <h2>üîê Login</h2>
    <input id="accessCode" placeholder="Enter Access Code" />
    <button onclick="login()">Login</button>
  </div>

  <div class="card" id="dashboard" style="display:none">
    <h2>üìä Dashboard</h2>
    <p id="welcome"></p>
    <p>Your Ad URL:</p>
    <pre id="adUrl"></pre>
    <h3>Stats</h3>
    <div id="statsBox">Loading...</div>
    <h3>Console Log</h3>
    <pre id="console"></pre>
    <button onclick="refreshStats()">Refresh</button>
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    const tokenGistUrl = "https://gist.githubusercontent.com/Preasx24/c54812fe3d3e5f8d586f1dd010701919/raw/e6ebaaa6f2bb72ad1d2444b10ffb059f9c990fbe/gistfile1.txt";
    const mappingGistId = "4517ac43eff88b7e226fbbdc627a3c08";

    function log(msg) {
      const consoleBox = document.getElementById('console');
      consoleBox.textContent += msg + "\n";
      consoleBox.scrollTop = consoleBox.scrollHeight;
    }

    async function getGitHubToken() {
      const res = await fetch(tokenGistUrl);
      return (await res.text()).trim();
    }

    async function fetchMapping(token) {
      const res = await fetch(`https://api.github.com/gists/${mappingGistId}`, {
        headers: { "Authorization": `token ${token}` }
      });
      const data = await res.json();
      return JSON.parse(data.files["gistfile1.txt"].content || "{}");
    }

    async function saveMapping(token, mapping) {
      await fetch(`https://api.github.com/gists/${mappingGistId}`, {
        method: "PATCH",
        headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" },
        body: JSON.stringify({ files: { "gistfile1.txt": { content: JSON.stringify(mapping, null, 2) } } })
      });
    }

    async function login() {
      const code = document.getElementById("accessCode").value.trim();
      if (!code) return alert("Enter code");
      localStorage.setItem("userCode", code);
      document.getElementById("authCard").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("welcome").textContent = `Welcome, ${code}`;
      document.getElementById("adUrl").textContent = `https://revenue.dtech-services.co.za/track.html#${code}`;
      await refreshStats();
    }

    async function refreshStats() {
      const code = localStorage.getItem("userCode");
      const token = await getGitHubToken();
      let mapping = await fetchMapping(token);
      let gistId = mapping[code];
      if (!gistId) {
        log("Creating new gist for " + code);
        const res = await fetch("https://api.github.com/gists", {
          method: "POST",
          headers: { "Authorization": `token ${token}` },
          body: JSON.stringify({
            description: `Stats for ${code}`,
            public: false,
            files: { "stats.json": { content: JSON.stringify({ totalClicks:0, todayClicks:0, totalRevenue:0, todayRevenue:0 }, null, 2) } }
          })
        });
        const data = await res.json();
        gistId = data.id;
        mapping[code] = gistId;
        await saveMapping(token, mapping);
      }
      const gistRes = await fetch(`https://api.github.com/gists/${gistId}`, {
        headers: { "Authorization": `token ${token}` }
      });
      const gistData = await gistRes.json();
      const stats = JSON.parse(gistData.files["stats.json"].content);
      document.getElementById("statsBox").textContent = JSON.stringify(stats, null, 2);
      log("Loaded stats for " + code);
    }

    function logout() {
      localStorage.removeItem("userCode");
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("authCard").style.display = "block";
    }
  </script>
</body>
</html>