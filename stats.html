<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AdRevenuePro Stats Dashboard</title>
<style>
:root {
  --primary: #6366f1;
  --primary-dark: #4f46e5;
  --secondary: #10b981;
  --dark-bg: #0f0f23;
  --card-bg: #1a1b2e;
  --card-border: #2d2d4d;
  --text: #e2e8f0;
  --text-muted: #94a3b8;
  --success: #10b981;
  --warning: #f59e0b;
  --error: #ef4444;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: var(--dark-bg);
  color: var(--text);
  line-height: 1.6;
  padding: 20px;
  min-height: 100vh;
  background-image: radial-gradient(circle at 15% 50%, rgba(29, 78, 216, 0.15) 0%, transparent 65%),
                    radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.1) 0%, transparent 55%);
}

.container {
  max-width: 900px;
  margin: 0 auto;
}

.header {
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.header h1 {
  font-size: 2.2rem;
  margin-bottom: 8px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  display: inline-block;
}

.header p {
  color: var(--text-muted);
  font-size: 1rem;
}

.card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  border: 1px solid var(--card-border);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
}

.card-header {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
}

.card-header h2 {
  font-size: 1.3rem;
  margin-left: 10px;
}

.icon {
  font-size: 1.6rem;
}

.stats-container {
  display: flex;
  gap: 20px;
  margin-bottom: 15px;
}

.stat-box {
  flex: 1;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 15px;
  text-align: center;
  border-left: 4px solid var(--primary);
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  margin: 5px 0;
  color: var(--secondary);
}

.stat-label {
  color: var(--text-muted);
  font-size: 0.85rem;
}

.graph-container {
  margin: 15px 0;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 12px;
  padding: 15px;
  position: relative;
  height: 180px;
}

.graph-placeholder {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  color: var(--text-muted);
  font-size: 1rem;
}

.graph-bar {
  display: flex;
  align-items: flex-end;
  justify-content: space-around;
  height: 100%;
  padding: 10px 0;
}

.bar {
  width: 22px;
  background: linear-gradient(to top, var(--primary), var(--secondary));
  border-radius: 4px 4px 0 0;
  position: relative;
  transition: height 0.5s ease;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.bar-label {
  position: absolute;
  bottom: -20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 0.7rem;
  color: var(--text-muted);
  white-space: nowrap;
}

.bar-value {
  position: absolute;
  top: -20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--text);
}

.graph-title {
  position: absolute;
  top: 8px;
  left: 15px;
  font-size: 0.9rem;
  font-weight: 600;
}

.url-container {
  margin-top: 10px;
}

.sharing-note {
  background: rgba(16, 185, 129, 0.1);
  border-left: 4px solid var(--success);
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 15px;
  font-size: 0.9rem;
}

.sharing-note strong {
  color: var(--success);
}

.url-box {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 12px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  position: relative;
  word-break: break-all;
}

.url-label {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 6px;
}

.copy-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.copy-btn:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
}

.copy-btn.copied {
  background: var(--success);
}

.action-buttons {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

.btn {
  flex: 1;
  padding: 12px 16px;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
  text-decoration: none;
  display: inline-block;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: var(--text);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: translateY(-2px);
}

.daily-stats {
  margin-top: 15px;
}

.daily-stats h3 {
  margin-bottom: 10px;
  font-size: 1.1rem;
}

.daily-list {
  max-height: 120px;
  overflow-y: auto;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  padding: 12px;
}

.daily-item {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  font-size: 0.85rem;
}

.daily-item:last-child {
  border-bottom: none;
}

.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--success);
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.3s ease;
  z-index: 1000;
}

.toast.show {
  transform: translateY(0);
  opacity: 1;
}

.loading {
  text-align: center;
  padding: 20px;
  color: var(--text-muted);
}

.spinner {
  border: 3px solid rgba(255, 255, 255, 0.1);
  border-radius: 50%;
  border-top: 3px solid var(--primary);
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: 0 auto 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@media (max-width: 600px) {
  .stats-container {
    flex-direction: column;
    gap: 12px;
  }

  .action-buttons {
    flex-direction: column;
  }

  .card {
    padding: 15px 12px;
  }
  
  .graph-container {
    height: 160px;
    padding: 12px;
  }
  
  .bar {
    width: 16px;
  }
  
  .bar-label {
    font-size: 0.6rem;
    bottom: -18px;
  }
  
  .bar-value {
    font-size: 0.6rem;
    top: -18px;
  }
  
  .daily-list {
    max-height: 100px;
  }
  
  .header h1 {
    font-size: 1.8rem;
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>AdRevenuePro Dashboard</h1>
    <p>Track your earnings and manage your links</p>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="icon">üìä</div>
      <h2>Your Performance Stats</h2>
    </div>
    <p id="welcome" style="margin-bottom: 15px;"></p>

    <div id="statsDetails" class="loading">
      <div class="spinner"></div>
      <p>Loading your statistics...</p>
    </div>
    
    <!-- Graph Container -->
    <div class="graph-container" id="graphContainer" style="display: none;">
      <div class="graph-title">Daily Clicks Overview (Last 7 Days)</div>
      <div class="graph-bar" id="graphBar"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="icon">üîó</div>
      <h2>Your Sharing URLs</h2>
    </div>

    <div class="sharing-note">
      <strong>Share these URLs</strong> on WhatsApp, Facebook, or other platforms to get more users to click and view the ads. The more people that view your links, the more revenue you'll earn!
    </div>

    <div class="url-container">
      <div class="url-box">
        <div class="url-label">Custom Track URL</div>
        <div id="trackUrl" class="url-text"></div>
        <button class="copy-btn" data-url="trackUrl">Copy</button>
      </div>

      <div class="url-box">
        <div class="url-label">Invite URL (max 10 loads/day)</div>
        <div id="inviteUrl" class="url-text"></div>
        <button class="copy-btn" data-url="inviteUrl" data-invite="true">Copy</button>
      </div>
    </div>

    <div class="action-buttons">
      <a href="out.html" class="btn btn-primary">Withdraw Earnings</a>
      <button class="btn btn-secondary" id="refreshBtn">Refresh Stats</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Copied to clipboard!</div>

<script>
const mappingUrl = "https://gist.githubusercontent.com/Preasx24/4517ac43eff88b7e226fbbdc627a3c08/raw/gistfile1.txt";
const tokenUrl = "https://gist.githubusercontent.com/Preasx24/c54812fe3d3e5f8d586f1dd010701919/raw/e6ebaaa6f2bb72ad1d2444b10ffb059f9c990fbe/gistfile1.txt";
const user = JSON.parse(localStorage.getItem("adRevenueUser") || "{}");

// Check if user is logged in
if (!user.accessCode) {
  document.body.innerHTML = `
    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column;">
      <h1 style="color: #ef4444; margin-bottom: 20px;">‚ùå Access Denied</h1>
      <p>You are not logged in. Please login to access your dashboard.</p>
      <a href="index.html" style="margin-top: 20px; padding: 10px 20px; background: #6366f1; color: white; border-radius: 8px; text-decoration: none;">Go to Login</a>
    </div>
  `;
  throw new Error("No user");
}

// Set welcome message
document.getElementById('welcome').textContent = `Welcome, ${user.username}!`;

// Set URLs
const trackUrl = `https://revenue.dtech-services.co.za/track.html#${user.accessCode}`;
const inviteUrl = `https://revenue.dtech-services.co.za/#${user.accessCode}`;

document.getElementById('trackUrl').textContent = trackUrl;
document.getElementById('inviteUrl').textContent = inviteUrl;

// Copy functionality
document.querySelectorAll('.copy-btn').forEach(button => {
  button.addEventListener('click', function() {
    const urlId = this.getAttribute('data-url');
    const isInvite = this.getAttribute('data-invite') === 'true';
    
    let textToCopy = document.getElementById(urlId).textContent;

    if (isInvite) {
      textToCopy = `Custom Track URL: ${trackUrl}\nInvite URL: ${inviteUrl}\n\nJoin me on AdRevenuePro - a user-friendly ad system that provides access to ad monetization through direct advertising. It's an easy way to generate revenue by sharing ad links and earning cash as people view and click those links!`;
    }

    // Copy to clipboard
    navigator.clipboard.writeText(textToCopy).then(() => {
      // Show toast notification
      const toast = document.getElementById('toast');
      if (isInvite) {
        toast.textContent = "Both URLs and invitation message copied!";
      } else {
        toast.textContent = "URL copied to clipboard!";
      }
      toast.classList.add('show');

      // Change button text temporarily
      const originalText = this.textContent;
      this.textContent = 'Copied!';
      this.classList.add('copied');

      setTimeout(() => {
        toast.classList.remove('show');
        this.textContent = originalText;
        this.classList.remove('copied');
      }, 3000);
    }).catch(err => {
      console.error('Failed to copy: ', err);
    });
  });
});

// Refresh button functionality
document.getElementById('refreshBtn').addEventListener('click', loadStats);

// Function to create the graph
function createGraph(dailyStats) {
  const graphContainer = document.getElementById('graphContainer');
  const graphBar = document.getElementById('graphBar');
  
  // Clear previous graph
  graphBar.innerHTML = '';
  
  // If no daily stats, show placeholder
  if (!dailyStats || Object.keys(dailyStats).length === 0) {
    graphBar.innerHTML = '<div class="graph-placeholder">No data available for graph</div>';
    graphContainer.style.display = 'block';
    return;
  }
  
  // Get the last 7 days of data (or all if less than 7)
  const dates = Object.keys(dailyStats).sort((a, b) => new Date(b) - new Date(a)).slice(0, 7).reverse();
  const values = dates.map(date => dailyStats[date].count);
  
  // Calculate max value for scaling
  const maxValue = Math.max(...values, 10); // Ensure at least 10 for scaling
  
  // Create bars
  dates.forEach((date, index) => {
    const barHeight = (values[index] / maxValue) * 70 + 15; // 70% of container height + 15% minimum
    const bar = document.createElement('div');
    bar.className = 'bar';
    bar.style.height = `${barHeight}%`;
    
    const barValue = document.createElement('div');
    barValue.className = 'bar-value';
    barValue.textContent = values[index];
    
    const barLabel = document.createElement('div');
    barLabel.className = 'bar-label';
    
    // Format date to be more readable (e.g., "Jan 15")
    const dateObj = new Date(date);
    barLabel.textContent = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    
    bar.appendChild(barValue);
    bar.appendChild(barLabel);
    graphBar.appendChild(bar);
  });
  
  // Show the graph
  graphContainer.style.display = 'block';
}

// Auto-scroll function to show users there's content below
function autoScrollToGraph() {
  // Check if we've already shown the auto-scroll for this session
  if (!sessionStorage.getItem('hasAutoScrolled')) {
    setTimeout(() => {
      const graphContainer = document.getElementById('graphContainer');
      if (graphContainer && graphContainer.style.display !== 'none') {
        graphContainer.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        sessionStorage.setItem('hasAutoScrolled', 'true');
      }
    }, 1500);
  }
}

async function loadStats() {
  const statsContainer = document.getElementById('statsDetails');
  statsContainer.innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading your statistics...</p>
    </div>
  `;

  try {
    const map = await fetch(mappingUrl).then(r => r.json());
    let entry = map.find(e => e.accessCode === user.accessCode);

    // If no entry, create a new gist and update mapping
    if (!entry) {
      const token = (await fetch(tokenUrl).then(r => r.text())).trim();
      const newGist = await fetch("https://api.github.com/gists", {
        method: "POST",
        headers: {
          "Authorization": "token " + token,
          "Accept": "application/vnd.github+json"
        },
        body: JSON.stringify({
          description: "AdRevenuePro stats for " + user.username,
          public: false,
          files: {"stats.json": {content: JSON.stringify({clicks: 0, revenue: 0, daily: {}}, null, 2)}}
        })
      }).then(r => r.json());

      entry = {accessCode: user.accessCode, gistUrl: newGist.html_url, username: user.username};
      map.push(entry);

      // Update main mapping gist
      await fetch("https://api.github.com/gists/4517ac43eff88b7e226fbbdc627a3c08", {
        method: "PATCH",
        headers: {
          "Authorization": "token " + token,
          "Accept": "application/vnd.github+json"
        },
        body: JSON.stringify({files: {"gistfile1.txt": {content: JSON.stringify(map, null, 2)}}})
      });
    }

    // Normalize gist API URL
    let gistApi;
    if (entry.gistUrl.includes("gist.github.com")) {
      const gistId = entry.gistUrl.split("/").pop();
      gistApi = "https://api.github.com/gists/" + gistId;
    } else if (entry.gistUrl.includes("api.github.com/gists/")) {
      gistApi = entry.gistUrl;
    } else {
      statsContainer.innerHTML = "<div style='color: var(--error); text-align: center; padding: 20px;'>‚ùå Invalid gist URL configuration</div>";
      return;
    }

    // Fetch stats
    const gist = await fetch(gistApi).then(r => r.json());
    let stats = {clicks: 0, revenue: 0, daily: {}};
    if (gist.files && gist.files["stats.json"]) {
      try { 
        stats = JSON.parse(gist.files["stats.json"].content); 
      } catch(e) { 
        console.warn("Invalid stats.json, resetting"); 
      }
    }

    // Build HTML display with stats side by side
    let html = `
      <div class="stats-container">
        <div class="stat-box">
          <div class="stat-label">Total Clicks</div>
          <div class="stat-value">${stats.clicks.toLocaleString()}</div>
          <div class="stat-desc">All-time click count</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Total Revenue</div>
          <div class="stat-value">$${stats.revenue.toFixed(3)}</div>
          <div class="stat-desc">Your earnings</div>
        </div>
      </div>
    `;

    // Create the graph
    createGraph(stats.daily);

    if (stats.daily && Object.keys(stats.daily).length) {
      html += `
        <div class="daily-stats">
          <h3>üìà Daily Performance</h3>
          <div class="daily-list">
      `;

      // Sort dates in descending order (newest first)
      const sortedDates = Object.keys(stats.daily).sort((a, b) => new Date(b) - new Date(a));

      for (const day of sortedDates) {
        html += `
          <div class="daily-item">
            <span>${day}</span>
            <span><strong>${stats.daily[day].count}</strong> clicks</span>
          </div>
        `;
      }

      html += `</div></div>`;
    }

    statsContainer.innerHTML = html;
    
    // Auto-scroll to graph after content loads
    autoScrollToGraph();
  } catch (error) {
    console.error("Error loading stats:", error);
    statsContainer.innerHTML = `
      <div style="color: var(--error); text-align: center; padding: 20px;">
        ‚ùå Error loading statistics. Please try again.
      </div>
    `;
  }
}

// Load stats on page load
loadStats();
</script>
</body>
</html>